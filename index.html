<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Melody's Mystery Elevator</title>
  <style>
    body {
      margin: 0;
      text-align: center;
      background-color: white;
      font-family: Arial, sans-serif;
    }

    /* ——— CORE PLAY AREA ——— */
    #visual-container {
      width: 90vw;
      height: 80vh;
      max-width: 1400px;
      max-height: 950px;
      margin: 80px auto 0;
      background-color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
      overflow: hidden;
      position: relative;
    }

    /* Dynamic overlay */
    #screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: transparent;
      padding: 40px;
      box-sizing: border-box;
    }

    .media-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: none;
    }

    .btn-primary {
      padding: 20px 48px;
      font-size: 1.2em;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg,#f3e7ff,#d0b3ff);
      color: #4b2e83;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .btn-primary:hover {
      transform: scale(1.05);
    }

    .tempo-btn, .elevator-option {
      cursor: pointer;
      margin: 0 8px;
    }
  </style>
</head>
<body>
  <div id="visual-container">
    <div id="screen"></div>
    <!-- Hidden real‑trial assets -->
    <img id="stillframe1" class="media-content" src="stillframe1.png">
    <img id="gapStillframe" class="media-content" src="gapStillframe.png">
    <img id="stillframe2" class="media-content" src="stillframe2.png">
    <video id="video1" class="media-content" src="video1.mp4" playsinline preload="auto" muted></video>
    <video id="gapVideo" class="media-content" src="gapVideo.mp4" playsinline preload="auto" muted></video>
    <video id="video2" class="media-content" src="video2.mp4" playsinline preload="auto" muted></video>
  </div>
  <div id="trialControls"></div>
  <audio id="myAudio" hidden preload="auto"></audio>
  <audio id="introNarration" src="intro_narration.mp3" hidden preload="auto"></audio>

  <script>
    //—— Helpers ——
    function updateScreen(html, bg = 'transparent') {
      const s = document.getElementById('screen');
      s.innerHTML = html;
      s.style.background = bg;
    }
    function hideAllMedia() {
      document.querySelectorAll('.media-content').forEach(el => {
        el.style.display = 'none';
        if (el.tagName === 'VIDEO') { el.pause(); el.currentTime = 0; }
      });
    }

    //—— State ——
    let participantID = '', sessionID = '';
    const TRIALS_PER_BLOCK = 2;
    const BLOCK_ORDER = ['tempo','pitch'];
    let currentBlockIndex = 0, trialCounter = 1;
    let trialStartTime = 0, currentAudioFile = '';
    let visuals = [];

    window.onload = () => {
      (function askID(){
        participantID = (prompt('Enter your Participant ID:') || '').trim();
        if (!participantID) return askID();
        sessionID = `${participantID}_${new Date().toISOString()}`;
        setupVisuals();
        showIntroScreen();
      })();
    };

    function setupVisuals(){
      visuals = [
        'stillframe1','video1','gapStillframe','gapVideo','video2','stillframe2'
      ].map(id => ({ el: document.getElementById(id), start:0, end:0 }));
    }

    //—— 1. INTRO SCREEN ——
    function showIntroScreen(){
      updateScreen(`
        <div style="display:flex;align-items:center;justify-content:center;height:100%;">
          <div style="flex:1;display:flex;justify-content:center;">
            <img src="Melody.png" style="max-width:90%;max-height:80vh;border-radius:20px;">
          </div>
          <div style="flex:1;text-align:left;padding:30px;">
            <p style="font-size:1.5em;line-height:1.6;">
              Hi there!<br>
              My name is Melody, and I love music!<br>
              Every day, I ride an elevator to music class.<br>
              But today, something strange is happening...
            </p>
            <button id="btnIntro" class="btn-primary">Click to Play</button>
          </div>
        </div>
      `);
      document.getElementById('btnIntro').onclick = () => {
        document.getElementById('introNarration').play().catch(()=>{});
        document.getElementById('introNarration').onended = showFastDemo;
      };
    }

    //—— 2. FAST DEMO ——
    function showFastDemo(){
      hideAllMedia();
      updateScreen('', 'black');
      const v = document.getElementById('video1');
      v.style.display = 'block';
      v.play().catch(()=>{});
      v.onended = showSlowDemo;
    }

    //—— 3. SLOW DEMO ——
    function showSlowDemo(){
      hideAllMedia();
      updateScreen('', 'black');
      const v = document.getElementById('video2');
      v.style.display = 'block';
      v.play().catch(()=>{});
      v.onended = showPracticeStart;
    }

    //—— 4. PRACTICE START ——
    function showPracticeStart(){
      updateScreen(`
        <p>Now practice: faster, slower, or the same?</p>
        <button id="btnPractice" class="btn-primary">Begin Practice</button>
      `, 'white');
      document.getElementById('btnPractice').onclick = runTempoPractice;
    }

    //—— 5. TEMPO PRACTICE ——
    function runTempoPractice(){
      const trials = [
        {file:'PT_FAST2.mp4',correct:'fast'},
        {file:'PT_SLOW2.mp4',correct:'slow'}
      ];
      let i=0;
      function next(){
        if(i>=trials.length) return showRealTempoIntro();
        playPracticeVideo(trials[i].file, trials[i].correct, ()=>{ i++; next(); });
      }
      next();
    }
    function playPracticeVideo(src, correct, cb){
      hideAllMedia();
      updateScreen('', 'black');
      const vid = document.createElement('video');
      vid.src = src; vid.autoplay = true; vid.playsInline = true;
      vid.style.cssText = 'max-width:100%;max-height:100%;object-fit:contain;';
      document.getElementById('visual-container').appendChild(vid);
      vid.onended = ()=>{ vid.remove(); showPracticeResponse(correct, cb); };
    }
    function showPracticeResponse(correct, cb){
      updateScreen(`
        <h2>How did it sound?</h2>
        <button data-choice="fast" class="tempo-btn btn-primary">Fast</button>
        <button data-choice="slow" class="tempo-btn btn-primary">Slow</button>
        <button data-choice="same" class="tempo-btn btn-primary">Same</button>
        <div id="fb" style="margin-top:20px;"></div>
      `,'white');
      document.querySelectorAll('.tempo-btn').forEach(b=>{
        b.onclick = ()=>{
          const fb = document.getElementById('fb');
          if(b.getAttribute('data-choice')===correct){
            fb.innerHTML = '<p style="color:green;">Correct!</p>';
            setTimeout(cb,800);
          } else {
            fb.innerHTML = '<p style="color:red;">Try again.</p>';
          }
        };
      });
    }

    //—— 6. REAL TEMPO INTRO ——
    function showRealTempoIntro(){
      updateScreen(`
        <p>Great! Ready for real tempo trials?</p>
        <button id="btnReal" class="btn-primary">Start Real Tempo</button>
      `,'white');
      document.getElementById('btnReal').onclick = startRealTempo;
    }
    function startRealTempo(){
      hideAllMedia();
      updateScreen(`<h2>Real Tempo Trial 1 of ${TRIALS_PER_BLOCK}</h2>`,'white');
      document.getElementById('trialControls').innerHTML =
        `<button id="playButton" class="btn-primary">Play Trial</button>`;
      document.getElementById('playButton').onclick = playTempoTrial;
    }

    //—— 7. PLAY TEMPO TRIAL ——
    async function playTempoTrial(){
      document.getElementById('trialControls').innerHTML='';
      updateScreen('','transparent');
      hideAllMedia();
      const block = BLOCK_ORDER[currentBlockIndex];
      const [filename, orig, gap, test] = blocks[block][trialCounter-1];
      const audio = document.getElementById('myAudio');
      audio.src = filename; currentAudioFile = filename;

      const vids = visuals.map(v=>v.el).filter(el=>el.tagName==='VIDEO');
      const [v1,vGap,v2] = vids;
      await Promise.all([
        v1.play().then(()=>v1.pause()),
        vGap.play().then(()=>vGap.pause()),
        v2.play().then(()=>v2.pause())
      ]);

      // compute timings
      let t=0;
      const d1=v1.duration, dGap=vGap.duration, d2=v2.duration;
      visuals[0].start=t; visuals[0].end=t+=Math.max(0,parseFloat(orig)-d1);
      visuals[1].start=t; visuals[1].end=t+=d1;
      visuals[2].start=t; visuals[2].end=t+=Math.max(0,parseFloat(gap)-dGap);
      visuals[3].start=t; visuals[3].end=t+=dGap;
      visuals[4].start=t; visuals[4].end=t+=d2;
      visuals[5].start=t; visuals[5].end=t+=Math.max(0,parseFloat(test)-d2);

      await new Promise(r=>audio.oncanplaythrough=r);

      trialStartTime = performance.now();
      function step(){
        const ct = audio.currentTime;
        for(const v of visuals){
          if(ct>=v.start && ct<v.end){
            hideAllMedia();
            v.el.style.display='block';
            if(v.el.tagName==='VIDEO') v.el.play();
            break;
          }
        }
        if(ct<visuals[5].end) requestAnimationFrame(step);
        else{ hideAllMedia(); showTempoResponseOptions(); }
      }
      audio.play(); step();
    }

    function showTempoResponseOptions(){
      updateScreen(`
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:20px;">
          <h1 style="color:#4b2e83;">Which elevator did Melody ride?</h1>
          <p style="max-width:600px;line-height:1.4;">
            If it stayed the same, choose <strong>Normal</strong>.<br>
            If it changed, choose <strong>Wonky</strong>.
          </p>
          <div style="display:flex;gap:40px;margin-top:20px;">
            <div style="text-align:center;">
              <img src="normal.jpg" id="normalElevator" style="width:200px;cursor:pointer;"><div>Normal</div>
            </div>
            <div style="text-align:center;">
              <img src="wonky.png" id="wonkyElevator" style="width:200px;cursor:pointer;"><div>Wonky</div>
            </div>
          </div>
        </div>
      `);
      document.getElementById('normalElevator').onclick = ()=>handleResponse('normal');
      document.getElementById('wonkyElevator').onclick  = ()=>handleResponse('wonky');
    }

    function handleResponse(choice){
      // ...your POST logic...
      // then advance counters or end
      trialCounter++;
      if(trialCounter>TRIALS_PER_BLOCK){
        trialCounter=1;
        currentBlockIndex++;
        if(currentBlockIndex>=BLOCK_ORDER.length){
          updateScreen('<h1>Thank you! All trials complete.</h1>');
          return;
        }
      }
      // if next is pitch-practice start:
      if(currentBlockIndex===1){
        showPitchDemo();
      } else {
        showRealTempoIntro();
      }
    }

    //—— 8. PITCH DEMO ——
    function showPitchDemo(){
      updateScreen(`
        <p>Next: pitch demo.</p>
        <button id="btnPitchDemo" class="btn-primary">Start Pitch Demo</button>
      `,'white');
      document.getElementById('btnPitchDemo').onclick = ()=>{
        playPracticeVideo('PT_HIGH1.mp4','fast',()=>{
          playPracticeVideo('PT_LOW1.mp4','slow', showPitchPracticeStart);
        });
      };
    }

    //—— 9. PITCH PRACTICE START ——
    function showPitchPracticeStart(){
      updateScreen(`
        <p>Practice pitch: high, low, or same.</p>
        <button id="btnPitchPractice" class="btn-primary">Begin Pitch Practice</button>
      `,'white');
      document.getElementById('btnPitchPractice').onclick = runPitchPractice;
    }

    //—— 10. PITCH PRACTICE ——
    function runPitchPractice(){
      const trials=[
        {file:'PT_HIGH2.mp4',correct:'fast'},
        {file:'PT_LOW2.mp4', correct:'slow'}
      ];
      let i=0;
      function next(){
        if(i>=trials.length) return showRealPitchIntro();
        playPracticeVideo(trials[i].file,trials[i].correct,()=>{ i++; next(); });
      }
      next();
    }

    //—— 11. REAL PITCH INTRO ——
    function showRealPitchIntro(){
      updateScreen(`
        <p>Now real pitch trials begin.</p>
        <button id="btnRealPitch" class="btn-primary">Start Real Pitch</button>
      `,'white');
      document.getElementById('btnRealPitch').onclick = startRealPitch;
    }
    function startRealPitch(){
      hideAllMedia();
      updateScreen(`<h2>Real Pitch Trial 1 of ${TRIALS_PER_BLOCK}</h2>`,'white');
      document.getElementById('trialControls').innerHTML =
        `<button id="playPitch" class="btn-primary">Play Pitch Trial</button>`;
      document.getElementById('playPitch').onclick = playPitchTrial;
    }

    //—— 12. PLAY PITCH TRIAL ——
    async function playPitchTrial(){
      // identical to playTempoTrial but using pitch blocks
      // ...
      // after visuals loop call showPitchResponseOptions()
    }

    function showPitchResponseOptions(){
      updateScreen(`
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:20px;">
          <h1 style="color:#4b2e83;">Which elevator did Melody ride?</h1>
          <p style="max-width:600px;line-height:1.4;">
            If it stayed the same, choose <strong>Normal</strong>.<br>
            If it changed, choose <strong>Wonky</strong>.
          </p>
          <div style="display:flex;gap:40px;margin-top:20px;">
            <div style="text-align:center;">
              <img src="normal.jpg" id="normPitch" style="width:200px;cursor:pointer;"><div>Normal</div>
            </div>
            <div style="text-align:center;">
              <img src="wonky.png" id="wonkyPitch" style="width:200px;cursor:pointer;"><div>Wonky</div>
            </div>
          </div>
        </div>
      `);
      document.getElementById('normPitch').onclick = ()=>handleResponse('normal');
      document.getElementById('wonkyPitch').onclick = ()=>handleResponse('wonky');
    }

  </script>
</body>
</html>





