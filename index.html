<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Melody's Mystery Elevator</title>
  <style>
    body{
      margin:0;
      text-align:center;
      background:#fff;
      font-family:Arial, sans-serif;
    }

    /* ——— CORE PLAY AREA ——— */
    #visual-container{
      width:90vw;
      height:80vh;
      max-width:1400px;
      max-height:950px;
      margin:80px auto 0;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 2px 12px rgba(0,0,0,.07);
      overflow:hidden;
      position:relative;
    }

    /* Dynamic overlay (every “screen” writes inside here) */
    #screen{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      flex-direction:column;
      background:transparent;
    }

 /* Still‑images & videos used in the REAL trials */
    .media-content {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* Global rule so *any* video / img you inject later also scales correctly */
    #visual-container video,
    #visual-container img{
      width:100%; height:100%;
      object-fit:cover;            /* change to ‘contain’ if you prefer letter‑boxing */
    }

    /* Full‑screen click‑overlay */
    #overlay{
      position:fixed; inset:0;
      background:#fff;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      z-index:1000;
    }

    /* Buttons */
    .btn-primary{
      padding:20px 48px;
      font-size:1.5em;
      border-radius:12px; border:none;
      background:linear-gradient(135deg,#f3e7ff,#d0b3ff);
      color:#4b2e83; font-weight:bold;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(75,46,131,.3);
      transition:transform .2s, box-shadow .2s;
    }
    .btn-primary:hover{transform:scale(1.05); box-shadow:0 6px 18px rgba(75,46,131,.4);}

    .tempo-btn,.elevator-option{cursor:pointer; transition:transform .2s;}
    .tempo-btn:hover,.elevator-option:hover{transform:scale(1.05);}
  </style>
</head>
<body>
  <!-- Full‑screen overlay (kept from original, hidden by default) -->
  <div id="overlay" style="display:none;"></div>

  <!-- Main visual area -->
  <div id="visual-container">
    <div id="screen"></div>

    <!-- Hidden trial assets (stillframes + videos) -->
    <img  class="media-content" id="stillframe1"   src="stillframe1.png"/>
    <img  class="media-content" id="gapStillframe" src="gapStillframe.png"/>
    <img  class="media-content" id="stillframe2"   src="stillframe2.png"/>
    <video class="media-content" id="video1"  src="video1.mp4"  playsinline preload="auto" muted></video>
    <video class="media-content" id="gapVideo" src="gapVideo.mp4"playsinline preload="auto" muted></video>
    <video class="media-content" id="video2"  src="video2.mp4"  playsinline preload="auto" muted></video>
  </div>

  <!-- Global audio -->
  <audio id="myAudio" hidden preload="auto"></audio>
  <audio id="narrationAudio" hidden preload="auto"></audio>
  <audio id="introNarration" src="intro_narration.mp3" hidden preload="auto"></audio>

  <!-- Sits outside #screen so it never gets wiped -->
  <div id="trialControls"></div>

  <script>
/* --------------------------------------------------
   HELPER – write every screen INSIDE #visual-container
--------------------------------------------------*/
function updateScreen(html,background=null){
  const s=document.getElementById("screen");
  s.innerHTML=html;
  s.style.background=background!==null?background:"transparent";
}

/* --------------------------------------------------
   GLOBAL CONSTANTS & STATE
--------------------------------------------------*/
const TRIALS_PER_BLOCK=2;
const BLOCK_ORDER=["tempo","pitch"];
const BLOCK_FILES={tempo:"tempo_trials.csv",pitch:"pitch_trials.csv"};

const PRACTICE_TRIALS={
  tempo:[
    {video:"PT_FAST1.mp4", narrationText:"This music is fast. The elevator sped up the song!", correct:"wonky", responseRequired:false},
    {video:"PT_SLOW2.mp4", narrationText:"Did the music change?", correct:"wonky", responseRequired:true}
  ],
  pitch:[                                     /* <‑‑ updated list */
    {video:"PT_HIGH2.mp4", narrationText:"This music sounds high‑pitched. The elevator changed the pitch!", correct:"wonky", responseRequired:false},
    {video:"PT_SLOW2.mp4", narrationText:"Did the music change?", correct:"wonky", responseRequired:true}
  ]
};

let blocks={tempo:[],pitch:[]};
let currentBlockIndex=0;
let trialCounter=1;
let participantID=null;
let sessionID=null;
let currentAudioFile="";
let responseSubmitted=false;
let trialStartTime=null;
const visuals=[];

/* --------------------------------------------------
   BOOTSTRAP
--------------------------------------------------*/
window.onload=async()=>{
  while(!participantID){participantID=prompt("Enter your Participant ID:"); if(participantID)participantID=participantID.trim();}
  sessionID=`${participantID}_${new Date().toISOString()}`;
  showIntroScreen();
};

    /* --------------------------------------------------
       INTRO FLOW – every “screen” now uses updateScreen()
    --------------------------------------------------*/
    function showIntroScreen() {
      updateScreen(`
        <div style="display:flex;align-items:center;justify-content:center;height:100%;padding:40px;box-sizing:border-box;">
          <div style="flex:1;display:flex;justify-content:center;">
            <img src="Melody.png" alt="Melody character" style="max-height:80vh;max-width:90%;border-radius:20px;" />
          </div>
          <div style="flex:1;padding:30px;">
            <p style="font-size:1.5em;line-height:1.6;">
              Hi there!<br>
              My name is Melody, and I love music!<br>
              Every day, I ride an elevator to get to music class.<br>
              But today, something strange is happening...
            </p>
            <button id="continueIntro" class="btn-primary" style="margin-top:30px;font-size:1em;">Click to Play</button>
          </div>
        </div>
        <audio id="introAudio" src="intro_narration.mp3"></audio>
      `);

      const introAudio = document.getElementById("introAudio");
      const continueBtn = document.getElementById("continueIntro");

      continueBtn.addEventListener("click", async () => {
        continueBtn.disabled = true;
        try {
          await introAudio.play();
        } catch (err) {
          console.warn("Autoplay blocked or failed:", err);
        }
        introAudio.onended = showIntroVideo;
      });
    }

    function showIntroVideo() {
      updateScreen(`
        <div style="display:flex;justify-content:center;align-items:center;height:100%;background:black;">
          <video id="introVideo" width="100%" height="100%" playsinline style="max-width:100%;max-height:100%;" muted>
            <source src="intro_video.mp4" type="video/mp4" />
            Your browser does not support the video tag.
          </video>
          <audio id="introNarration2" src="intro_narration2.mp3"></audio>
        </div>
      `, "black");

      const video = document.getElementById("introVideo");
      const narration = document.getElementById("introNarration2");
      const startPlayback = async () => {
        try {
          await Promise.all([video.play(), narration.play()]);
        } catch (err) {
          console.warn("Playback failed:", err);
        }
        video.onended = () => setTimeout(showNarrationScreen, 2000);
      };

      window.addEventListener("click", startPlayback, { once: true });
    }

    function showNarrationScreen() {
      updateScreen(`
        <div style="display:flex;justify-content:center;align-items:center;height:100%;background:white;padding:40px;box-sizing:border-box;">
          <div style="flex:1;display:flex;justify-content:center;">
            <img src="Melody.png" alt="Melody character" style="max-height:80vh;max-width:90%;border-radius:20px;" />
          </div>
          <div style="flex:1;text-align:center;padding:30px;">
            <p style="font-size:1.3em;line-height:1.8;">
              The magical elevator can do all sorts of silly things to the music!<br>
              Sometimes it makes the music go faster or slower...<br>
              Other times, the music sounds higher or lower than before!<br><br>
              Let’s practice together so you know what to listen for!
            </p>
            <button id="playNarration" class="btn-primary" style="margin-top:20px;font-size:1em;">Click to Play</button>
            <audio id="introNarration3" src="intro_narration3.mp3"></audio>
          </div>
        </div>
      `);

      const button = document.getElementById("playNarration");
      const audio = document.getElementById("introNarration3");

      button.addEventListener("click", async () => {
        button.disabled = true;
        try {
          await audio.play();
        } catch (err) {
          console.warn("Audio play failed:", err);
        }
        audio.onended = () => setTimeout(showFastIntro, 1500);
      });
    }

    /* --------------------------------------------------
       TEMPO PRACTICE FLOW
    --------------------------------------------------*/
    function showFastIntro() {
      updateScreen(`
        <div style="display:flex;justify-content:center;align-items:center;height:100%;background:white;padding:40px;box-sizing:border-box;">
          <p style="font-size:1.5em;line-height:1.8;max-width:800px;text-align:center;">
            First, we’re going to learn about tempo.<br>
            Tempo is how fast or slow the music goes.<br><br>
            Ready?<br>
            Listen to this song and pay attention to how the music changes to become faster when Melody rides the elevator to the second floor.
          </p>
          <audio id="fastNarration" src="PT_FAST1_NARRATION.mp3"></audio>
        </div>
      `);

      const narration = document.getElementById("fastNarration");
      narration.play().then(() => {
        narration.onended = playFastVideo;
      }).catch(err => {
        console.warn("Autoplay issue:", err);
        playFastVideo();
      });
    }

    function playFastVideo() {
      updateScreen(`
        <video id="fastVideo" width="100%" height="100%" playsinline style="background:black;">
          <source src="PT_FAST1.mp4" type="video/mp4" />
        </video>
      `, "black");
      const video = document.getElementById("fastVideo");
      video.play();
      video.onended = showSlowIntro;
    }

    function showSlowIntro() {
      updateScreen(`
        <div style="display:flex;justify-content:center;align-items:center;height:100%;background:white;padding:40px;box-sizing:border-box;">
          <p style="font-size:1.5em;line-height:1.8;max-width:800px;text-align:center;">
            Whoa! That was a fast ride!<br><br>
            Let’s try one more.<br>
            Now Melody is going to go super sloooow. Listen carefully!
          </p>
          <audio id="slowNarration" src="PT_SLOW1_NARRATION.mp3"></audio>
        </div>
      `);

      const narration = document.getElementById("slowNarration");
      narration.play().then(() => {
        narration.onended = playSlowVideo;
      }).catch(err => {
        console.warn("Autoplay issue:", err);
        playSlowVideo();
      });
    }

    function playSlowVideo() {
      updateScreen(`
        <video id="slowVideo" width="100%" height="100%" playsinline style="background:black;">
          <source src="PT_SLOW1.mp4" type="video/mp4" />
        </video>
      `, "black");
      const video = document.getElementById("slowVideo");
      video.play();
      video.onended = showTempoInstructions;
    }

    function showTempoInstructions() {
      setTimeout(() => {
        updateScreen(`
          <div style="display: flex; justify-content: center; align-items: center; height: 100%; background: white; padding: 40px; box-sizing: border-box;">
            <p style="font-size: 1.5em; line-height: 1.8; max-width: 800px; text-align: center;">
              Great! Now let's practice even more.<br><br>
              Listen carefully and tell me if the music is <strong>faster</strong>, <strong>slower</strong>, or <strong>the same</strong>!
            </p>
            <audio id="tempoInstructions" src="PT_TEMPO_INSTRUCTIONS.mp3"></audio>
          </div>
        `);

        const audio = document.getElementById("tempoInstructions");
        audio.play().then(() => {
          audio.onended = () => {
            setTimeout(() => {
              runTempoPractice();
            }, 1000);
          };
        }).catch(err => {
          console.warn("Autoplay issue:", err);
          runTempoPractice();
        });
      }, 1500);
    }

function runTempoPractice(){
  const practiceTrials = [
    { video: "PT_FAST2.mp4", correct: "fast" },
    { video: "PT_SLOW2.mp4", correct: "slow" }
  ];
  let i = 0;

  function nextPractice(){
    if(i >= practiceTrials.length){
      showRealTrialsIntro();
      return;
    }
    const trial = practiceTrials[i++];
    playTempoPracticeVideo(trial.video, trial.correct, nextPractice);
  }

  nextPractice();
}

function playTempoPracticeVideo(videoFile, correctAnswer, callback) {
  updateScreen(`
    <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#cce0dd;">
      <video id="practiceVideo" playsinline muted autoplay style="width:100%; height:100%; object-fit:contain; background:#cce0dd;">
        <source src="${videoFile}" type="video/mp4">
      </video>
    </div>
  `, "#cce0dd");

  const video = document.getElementById("practiceVideo");

  video.onended = () => {
    showTempoResponseScreen(correctAnswer, callback);
  };

  // Handle autoplay restrictions or load failure
  video.play().catch(err => {
    console.warn("Autoplay issue or play failed:", err);
    showTempoResponseScreen(correctAnswer, callback);
  });
}

/* --------------------------------------------------
   PRACTICE‑GENERIC for tempo & pitch
--------------------------------------------------*/
function runPracticeTrials(blockType){
  const tc=document.getElementById("trialControls");
  let i=0;
  function showNarrationScreenPractice(trial,nextStep){
    tc.innerHTML=`<div style="padding:40px;font-size:1.4em;max-width:800px;margin:auto;">
        <p>${trial.narrationText}</p>
        <button id="continueButton" class="btn-primary" style="margin-top:20px;font-size:1em;">Continue</button>
      </div>`;
    document.getElementById("continueButton").addEventListener("click",()=>{
      tc.innerHTML=""; nextStep();
    });
  }
  function playNextPractice(){
    if(i>=PRACTICE_TRIALS[blockType].length){rebuildBaseHTML(); updatePlayButton(); return;}
    const trial=PRACTICE_TRIALS[blockType][i++];
    showNarrationScreenPractice(trial,()=>{
      updateScreen(`<video id="practiceVideo" playsinline preload="auto"></video>`);
      const v=document.getElementById("practiceVideo");
      v.src=trial.video;
      v.play();
      v.onerror=()=>{console.warn("Practice video failed:",trial.video); showPracticeChoice(trial.correct,playNextPractice);} /* NEW */
      v.onended=()=>{
        if(trial.responseRequired){
          showPracticeChoice(trial.correct,playNextPractice);
        }else{
          tc.innerHTML=`<div style="font-size:1.3em;margin-top:20px;">That was the <strong>${trial.correct}</strong> elevator!<br><br>Let's try one yourself next.</div>`;
          setTimeout(()=>{tc.innerHTML=""; playNextPractice();},4000);
        }
      };
    });
  }
  playNextPractice();
}
    function showTempoResponseScreen(correctAnswer, callback) {
      updateScreen(`
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #cce0dd; padding: 20px;">
          <h1 style="color: #4b2e83; margin-top: 30px;">How did the music sound?</h1>
          <div style="display: flex; gap: 40px; margin-top: 20px;">
            <button class="tempo-btn" data-choice="fast" style="padding: 14px 28px; font-size: 1.2em; border-radius: 10px;">Fast</button>
            <button class="tempo-btn" data-choice="slow" style="padding: 14px 28px; font-size: 1.2em; border-radius: 10px;">Slow</button>
            <button class="tempo-btn" data-choice="same" style="padding: 14px 28px; font-size: 1.2em; border-radius: 10px;">Same</button>
          </div>
          <audio id="correctSound" src="correct_feedback.mp3"></audio>
          <audio id="wrongSound" src="wrong_feedback.mp3"></audio>
          <div id="feedback" style="margin-top: 20px; font-size: 1.2em; color: red;"></div>
        </div>
      `, "#cce0dd");

      const buttons = document.querySelectorAll('.tempo-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const choice = btn.getAttribute('data-choice');
          if (choice === correctAnswer) {
            document.getElementById("feedback").style.color = "green";
            document.getElementById("feedback").innerHTML = "Correct!";
            document.getElementById("correctSound").play().then(() => {
              setTimeout(callback, 1500);
            });
          } else {
            document.getElementById("feedback").style.color = "red";
            document.getElementById("feedback").innerHTML = "Oops! Try again.";
            document.getElementById("wrongSound").play();
          }
        });
      });
    }

    function showRealTrialsIntro() {
      setTimeout(() => {
        updateScreen(`
          <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; background: #cce0dd;">
            <h1 style="margin-top: 30px; color: #4b2e83;">Awesome! Now you're ready for the real trials!</h1>
            <button id="startRealTrials" class="btn-primary" style="margin-top: 20px; font-size: 1.2em;">Start</button>
          </div>
        `, "#cce0dd");

        document.getElementById("startRealTrials").addEventListener("click", () => {
          startRealTrials();
        });
      }, 1500);
    }

    /* --------------------------------------------------
       REAL TRIALS  (unchanged logic, but no more document.body manipulation)
    --------------------------------------------------*/

    function setupVisualElements() {
      visuals.length = 0;
      visuals.push(
        { el: document.getElementById("stillframe1"), start: 0, end: 0 },
        { el: document.getElementById("video1"), start: 0, end: 0 },
        { el: document.getElementById("gapStillframe"), start: 0, end: 0 },
        { el: document.getElementById("gapVideo"), start: 0, end: 0 },
        { el: document.getElementById("video2"), start: 0, end: 0 },
        { el: document.getElementById("stillframe2"), start: 0, end: 0 }
      );
    }

    function updatePlayButton() {
      const block = BLOCK_ORDER[currentBlockIndex];
      const trialControls = document.getElementById("trialControls");
      trialControls.innerHTML = `<button id="playButton" class="btn-primary">Start ${block.toUpperCase()} Trial ${trialCounter} of ${TRIALS_PER_BLOCK}</button>`;
      document.getElementById("playButton").addEventListener("click", playTrial);
    }

    function hideAll() {
      visuals.forEach(v => {
        v.el.style.display = "none";
        if (v.el.tagName === "VIDEO") {
          v.el.pause();
          v.el.currentTime = 0;
        }
      });
    }

    async function playTrial() {
      document.getElementById("trialControls").innerHTML = "";
      updateScreen(""); // clear overlay so only video assets play
      hideAll();

      const block = BLOCK_ORDER[currentBlockIndex];
      const trial = blocks[block][trialCounter - 1];
      const [filename, original, gap, test] = trial;

      const originalSec = parseFloat(original);
      const gapSec = parseFloat(gap);
      const testSec = parseFloat(test);

      const audio = document.getElementById("myAudio");
      audio.src = filename;
      currentAudioFile = filename;

      const [v1, vGap, v2] = visuals.filter(v => v.el.tagName === "VIDEO").map(v => v.el);
      await Promise.all([v1.play().then(() => v1.pause()), vGap.play().then(() => vGap.pause()), v2.play().then(() => v2.pause())]);

      const video1Sec = v1.duration;
      const gapVideoSec = vGap.duration;
      const video2Sec = v2.duration;
      const preStillSec = Math.max(0, originalSec - video1Sec);
      const gapStillSec = Math.max(0, gapSec - gapVideoSec);
      const postStillSec = Math.max(0, testSec - video2Sec);

      let t = 0;
      visuals[0].start = t;
      visuals[0].end = t += preStillSec;
      visuals[1].start = t;
      visuals[1].end = t += video1Sec;
      visuals[2].start = t;
      visuals[2].end = t += gapStillSec;
      visuals[3].start = t;
      visuals[3].end = t += gapVideoSec;
      visuals[4].start = t;
      visuals[4].end = t += video2Sec;
      visuals[5].start = t;
      visuals[5].end = t += postStillSec;

      await new Promise((resolve, reject) => {
        audio.oncanplaythrough = resolve;
        audio.onerror = () => reject("Audio failed to load");
      });

      trialStartTime = performance.now();
      let currentVisual = null;

      function updateVisuals() {
        const time = audio.currentTime;
        for (const v of visuals) {
          if (time >= v.start && time < v.end) {
            if (currentVisual !== v.el) {
              hideAll();
              v.el.style.display = "block";
              if (v.el.tagName === "VIDEO") v.el.play();
              currentVisual = v.el;
            }
            break;
          }
        }
        if (time < visuals[visuals.length - 1].end) {
          requestAnimationFrame(updateVisuals);
        } else {
          hideAll();
          showResponseOptions();
        }
      }

      await audio.play();
      updateVisuals();
    }

    function showResponseOptions() {
      updateScreen(`
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px;">
          <h1 style="color: #4b2e83;">Which elevator did Melody ride?</h1>
          <p style="max-width: 600px; font-size: 1.1em; margin-bottom: 30px;">
            Now that the music is over, think back to how it sounded before and after the pause.<br><br>
            If the music stayed the same, choose the <strong>normal</strong> elevator.<br>
            If the music changed after the pause, choose the <strong>wonky</strong> elevator.
          </p>
          <div style="display: flex; justify-content: center; gap: 80px;">
            <div style="text-align: center;">
              <img src="normal.jpg" class="elevator-option" id="normalElevator" alt="Normal Elevator" style="width:300px;">
              <div style="margin-top: 12px; font-weight: bold;">Normal Elevator</div>
            </div>
            <div style="text-align: center;">
              <img src="wonky.png" class="elevator-option" id="wonkyElevator" alt="Wonky Elevator" style="width:300px;">
              <div style="margin-top: 12px; font-weight: bold;">Wonky Elevator</div>
            </div>
          </div>
        </div>`);

      document.getElementById("normalElevator").addEventListener("click", () => handleResponse("normal"), { once: true });
      document.getElementById("wonkyElevator").addEventListener("click", () => handleResponse("wonky"), { once: true });
    }

    function handleResponse(choice) {
      if (responseSubmitted) return;
      responseSubmitted = true;
      const imgs = document.querySelectorAll('.elevator-option');
      imgs.forEach(img => img.style.pointerEvents = 'none');

      const reactionTimeSec = (performance.now() - trialStartTime) / 1000;
      const isNormal = /_gap(\.mp3)?$/.test(currentAudioFile);
      const correctAnswer = isNormal ? "normal" : "wonky";

      const entry = {
        participant: participantID,
        session: sessionID,
        block: BLOCK_ORDER[currentBlockIndex],
        trial_num: trialCounter,
        timestamp: new Date().toISOString(),
        choice,
        audio: currentAudioFile,
        correct_answer: correctAnswer,
        reaction_time_sec: parseFloat(reactionTimeSec.toFixed(3))
      };

      const backendlessURL = "https://api.backendless.com/04D99C8B-3B22-454C-889B-5E66A5798C47/38037288-90E3-4F8A-87D6-E052FCD03D67/data/responses";

      fetch(backendlessURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(entry)
      })
      .then(() => {
        trialCounter++;
        if (trialCounter > TRIALS_PER_BLOCK) {
          trialCounter = 1;
          currentBlockIndex++;
        }
        if (currentBlockIndex >= BLOCK_ORDER.length) {
          updateScreen(`<h1>Thank you for participating! All trials complete.</h1>`);
        } else {
          rebuildBaseHTML();
          runPracticeTrials(BLOCK_ORDER[currentBlockIndex]);
        }
      })
      .catch(err => {
        console.error("Submission error:", err);
        alert("Failed to record response.");
        responseSubmitted = false;
      });
    }

    function rebuildBaseHTML() {
      updateScreen(""); // clear overlay
      document.getElementById("trialControls").innerHTML = "";
      responseSubmitted = false;
      setupVisualElements();
    }

    /* --------------------------------------------------
       PRACTICE TRIALS HELPERS (unchanged, but updateScreen in place of body changes)
    --------------------------------------------------*/
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function runPracticeTrials(blockType) {
      const trialControls = document.getElementById("trialControls");
      let i = 0;

      function showNarrationScreenPractice(trial, nextStep) {
        trialControls.innerHTML = `
          <div style="padding: 40px; font-size: 1.4em; max-width: 800px; margin: auto;">
            <p>${trial.narrationText}</p>
            <button id="continueButton" class="btn-primary" style="margin-top: 20px; font-size: 1em;">Continue</button>
          </div>
        `;
        document.getElementById("continueButton").addEventListener("click", () => {
          trialControls.innerHTML = "";
          nextStep();
        });
      }

      function playNextPractice() {
        if (i >= PRACTICE_TRIALS[blockType].length) {
          rebuildBaseHTML();
          updatePlayButton();
          return;
        }

        const trial = PRACTICE_TRIALS[blockType][i];
        i++;

        showNarrationScreenPractice(trial, () => {
          updateScreen(`<video id="practiceVideo" class="media-content" playsinline preload="auto" style="display: block; width: 100%; height: 100%;"></video>`);
          const video = document.getElementById("practiceVideo");
          video.src = trial.video;
          video.play();

          video.onended = () => {
            if (trial.responseRequired) {
              showPracticeChoice(trial.correct, playNextPractice);
            } else {
              trialControls.innerHTML = `<div style="font-size: 1.3em; margin-top: 20px;">That was the <strong>${trial.correct}</strong> elevator!<br><br>Let's try one yourself next.</div>`;
              setTimeout(() => {
                trialControls.innerHTML = "";
                playNextPractice();
              }, 4000);
            }
          };
        });
      }

      playNextPractice();
    }

    function showPracticeChoice(correctAnswer, onComplete) {
      document.getElementById("trialControls").innerHTML = `
        <h2>Which elevator did Melody ride?</h2>
        <div style="display: flex; justify-content: center; gap: 60px; margin-top: 20px;">
          <div>
            <img src="normal.jpg" class="elevator-option" id="normalElevatorPractice" alt="Normal Elevator" style="width:300px;">
            <div style="text-align: center; margin-top: 10px;">Normal</div>
          </div>
          <div>
            <img src="wonky.png" class="elevator-option" id="wonkyElevatorPractice" alt="Wonky Elevator" style="width:300px;">
            <div style="text-align: center; margin-top: 10px;">Wonky</div>
          </div>
        </div>
        <div id="practiceFeedback" style="margin-top: 30px; font-size: 1.2em;"></div>
      `;

      document.getElementById("normalElevatorPractice").addEventListener("click", () => {
        showPracticeFeedback("normal" === correctAnswer, onComplete);
      }, { once: true });

      document.getElementById("wonkyElevatorPractice").addEventListener("click", () => {
        showPracticeFeedback("wonky" === correctAnswer, onComplete);
      }, { once: true });
    }

    function showPracticeFeedback(isCorrect, onComplete) {
      const fb = document.getElementById("practiceFeedback");
      fb.innerHTML = isCorrect
        ? "<span style='color: green;'>Correct!</span> Great job!"
        : "<span style='color: red;'>Oops!</span> That was actually the <strong>" + (isCorrect ? "normal" : "wonky") + "</strong> elevator.";
      setTimeout(() => {
        document.getElementById("trialControls").innerHTML = "";
        onComplete();
      }, 3000);
    }

    /* --------------------------------------------------
       INITIALISE HIDDEN TRIAL ASSETS
    --------------------------------------------------*/
    setupVisualElements();
  </script>
</body>
</html>






