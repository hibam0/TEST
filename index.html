<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Melody's Mystery Elevator - Practice & Real Trials</title>
  <style>
    body{margin:0;text-align:center;background:#fff;font-family:Arial,sans-serif;}
    #visual-container{width:90vw;height:80vh;max-width:1400px;max-height:950px;margin:80px auto 0;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;}
    #screen{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:transparent;}
    .media-content{width:100%;height:100%;object-fit:contain;display:none;position:absolute;top:0;left:0;}
    #overlay{position:fixed;inset:0;background:#fff;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:1000;}
    .btn-primary{padding:20px 48px;font-size:1.5em;border-radius:12px;border:none;background:linear-gradient(135deg,#f3e7ff,#d0b3ff);color:#4b2e83;font-weight:bold;cursor:pointer;box-shadow:0 4px 12px rgba(75,46,131,.3);transition:transform .2s,box-shadow .2s;}
    .btn-primary:hover{transform:scale(1.05);box-shadow:0 6px 18px rgba(75,46,131,.4);}
    .tempo-btn,.elevator-option{cursor:pointer;transition:transform .2s;}
    .tempo-btn:hover,.elevator-option:hover{transform:scale(1.05);}
  </style>
</head>
<body>
  <div id="overlay"></div>
  <div id="visual-container">
    <div id="screen"></div>
    <img class="media-content" id="stillframe1" src="stillframe1.png" />
    <img class="media-content" id="gapStillframe" src="gapStillframe.png" />
    <img class="media-content" id="stillframe2" src="stillframe2.png" />
    <video class="media-content" id="video1" src="video1.mp4" playsinline preload="auto" muted></video>
    <video class="media-content" id="gapVideo" src="gapVideo.mp4" playsinline preload="auto" muted></video>
    <video class="media-content" id="video2" src="video2.mp4" playsinline preload="auto" muted></video>
  </div>
  <audio id="myAudio" hidden preload="auto"></audio>
  <div id="trialControls"></div>

  <script>
    // Globals
    const TRIALS_PER_BLOCK = 2;
    const BLOCK_ORDER = ["tempo","pitch"];
    const BLOCK_FILES = {tempo: "tempo_trials.csv", pitch: "pitch_trials.csv"};
    const PRACTICE_TRIALS = {
      tempo: [
        {video: "PT_FAST1.mp4", narration: "This music is fast. The elevator sped up the song!", correct:"fast", responseRequired:false},
        {video: "PT_FAST2.mp4", narration: "Did the music change?", correct:"fast", responseRequired:true},
        {video: "PT_SLOW1.mp4", narration: "This music is slow. The elevator slowed the song!", correct:"slow", responseRequired:false},
        {video: "PT_SLOW2.mp4", narration: "Did the music change?", correct:"slow", responseRequired:true}
      ],
      pitch: [
        {video: "PT_HIGH1.mp4", narration: "This music sounds higher. The elevator raised the pitch!", correct:"high", responseRequired:false},
        {video: "PT_HIGH2.mp4", narration: "Did the music change?", correct:"high", responseRequired:true},
        {video: "PT_LOW1.mp4", narration: "This music sounds lower. The elevator lowered the pitch!", correct:"low", responseRequired:false},
        {video: "PT_LOW2.mp4", narration: "Did the music change?", correct:"low", responseRequired:true}
      ]
    };
    let blocks = {tempo:[], pitch:[]}, currentBlockIndex=0, trialCounter=1;
    let participantID, sessionID, currentAudioFile, trialStartTime;
    let visuals = [];

    window.onload = async () => {
      // Participant prompt
      while(!participantID){participantID = prompt("Enter your Participant ID:"); if(participantID) participantID = participantID.trim();}
      sessionID = `${participantID}_${new Date().toISOString()}`;
      // Start practice for first block
      runPracticeTrials(BLOCK_ORDER[currentBlockIndex]);
    };

    function updateScreen(html, bg="transparent"){
      const s = document.getElementById("screen");
      s.innerHTML = html;
      s.style.background = bg;
    }

    // Practice Trials Runner
    function runPracticeTrials(blockType){
      let i=0;
      const next = () => {
        if(i>=PRACTICE_TRIALS[blockType].length){
          showRealTrialsIntro();
          return;
        }
        const t = PRACTICE_TRIALS[blockType][i++];
        updateScreen(`
          <p style="font-size:1.5em;max-width:800px;">${t.narration}</p>
          <audio id="narrate" src="${t.video.replace('.mp4','_NARRATION.mp3')}"></audio>
        ");
        const nar = document.getElementById("narrate");
        nar.play().catch(()=>{});
        nar.onended = () => playPracticeVideo(t);
      };
      next();

      function playPracticeVideo(trial){
        updateScreen(`<video id="pv" playsinline style="width:100%;height:100%;"><source src="${trial.video}" type="video/mp4"></video>`,"black");
        const v = document.getElementById("pv");
        v.play().catch(()=>{});
        v.onended = () => {
          if(trial.responseRequired) showPracticeChoice(trial.correct, next);
          else setTimeout(next,2000);
        };
      }

      function showPracticeChoice(correct, cb){
        updateScreen(`
          <h2>Did Melody's ride change the music?</h2>
          <button class="tempo-btn" data-choice="${correct}">${correct}</button>
          <button class="tempo-btn" data-choice="${correct==='fast'?'slow':'fast'}">${correct==='fast'?'slow':'fast'}</button>
          <div id="fb" style="margin-top:20px;font-size:1.2em;"></div>
        ');
        document.querySelectorAll('.tempo-btn').forEach(b=>b.onclick=()=>{
          const choice=b.getAttribute('data-choice');
          const fb=document.getElementById('fb');
          if(choice===correct){fb.textContent='Correct!';setTimeout(cb,1500);} else {fb.textContent='Oops! Try again.';}
        });
      }
    }

    // Real Trials Intro
    function showRealTrialsIntro(){
      updateScreen(`<h1>Great! Now for the real trials.</h1><button id="startReal" class="btn-primary">Start</button>`,"#cce0dd");
      document.getElementById('startReal').onclick = startRealTrials;
    }

    async function startRealTrials(){
      // load CSVs
      for(const b of BLOCK_ORDER){
        const resp = await fetch(BLOCK_FILES[b]);
        const txt = await resp.text();
        blocks[b] = txt.trim().split('\n').slice(1).map(r=>r.split(',').map(x=>x.trim()));
      }
      setupVisuals(); updatePlayButton();
    }

    function setupVisuals(){
      visuals = [
        {el:document.getElementById('stillframe1')},
        {el:document.getElementById('video1')},
        {el:document.getElementById('gapStillframe')},
        {el:document.getElementById('gapVideo')},
        {el:document.getElementById('video2')},
        {el:document.getElementById('stillframe2')}
      ];
    }

    function updatePlayButton(){
      document.getElementById('trialControls').innerHTML = `<button id="playButton" class="btn-primary">Start ${BLOCK_ORDER[currentBlockIndex].toUpperCase()} #${trialCounter}</button>`;
      document.getElementById('playButton').onclick = playRealTrial;
    }

    function hideAll(){visuals.forEach(v=>{v.el.style.display='none';if(v.el.tagName=='VIDEO'){v.el.pause();v.el.currentTime=0;}});}    

    async function playRealTrial(){
      document.getElementById('trialControls').innerHTML=''; hideAll(); updateScreen('');
      const block=BLOCK_ORDER[currentBlockIndex];
      const [file,o,g,t]=blocks[block][trialCounter-1];
      const audio=document.getElementById('myAudio'); audio.src=file;
      // prepare durations
      const vids=visuals.filter(v=>v.el.tagName=='VIDEO').map(v=>v.el);
      await Promise.all(vids.map(v=>v.play().then(()=>v.pause())));
      const durs=[parseFloat(o)-vids[0].duration, vids[0].duration, parseFloat(g)-vids[1].duration, vids[1].duration, vids[2].duration, parseFloat(t)-vids[2].duration];
      let tt=0; for(let i=0;i<visuals.length;i++){visuals[i].start=tt;visuals[i].end=tt+=Math.max(0,durs[i]);}
      await new Promise(r=>{audio.oncanplaythrough=r;}); trialStartTime=performance.now(); audio.play();
      (function loop(){const ct=audio.currentTime;for(const v of visuals){if(ct>=v.start&&ct<v.end){hideAll();v.el.style.display='block';if(v.el.tagName=='VIDEO')v.el.play();break;}} if(ct<visuals[5].end)requestAnimationFrame(loop);else{hideAll(); showRealChoice();}})();
    }

    function showRealChoice(){
      updateScreen(`
        <h1>Which elevator did Melody ride?</h1>
        <button class="elevator-option" data-choice="normal">Normal</button>
        <button class="elevator-option" data-choice="wonky">Wonky</button>
      `);
      document.querySelectorAll('.elevator-option').forEach(b=>b.onclick=()=>handleRealChoice(b.getAttribute('data-choice')));
    }

    function handleRealChoice(choice){
      const rt=(performance.now()-trialStartTime)/1000;
      const correct = /_gap/.test(currentAudioFile)?'normal':'wonky';
      // send data
      fetch('https://api.backendless.com/.../data/responses',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({participant:participantID,session:sessionID,block:BLOCK_ORDER[currentBlockIndex],trial:trialCounter,choice,audio:currentAudioFile,correct,rt})});
      // advance
      trialCounter++; if(trialCounter>TRIALS_PER_BLOCK){trialCounter=1;currentBlockIndex++;}
      if(currentBlockIndex>=BLOCK_ORDER.length){updateScreen('<h1>All done, thanks!</h1>');}
      else updatePlayButton();
    }
  </script>
</body>
</html>









