<!DOCTYPE html>
<html>
<head>
  <script src="jspsych.js"></script>
  <link href="jspsych.css" rel="stylesheet" />
  <style>
    body {
      text-align: center;
      background-color: #f0f0f0;
      padding-top: 50px;
    }
    #visual-container {
      width: 800px;
      height: 450px;
      margin: auto;
      background-color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    video, img {
      max-width: 100%;
      max-height: 100%;
      display: none;
    }
  </style>
</head>
<body>

  <div id="visual-container">
    <img id="stillframe1" src="stillframe1.png" />
    <img id="gapStillframe" src="gapStillframe.png" />
    <img id="stillframe2" src="stillframe2.png" />
    <video id="video1" src="video1.mp4" preload="auto" playsinline muted></video>
    <video id="gapVideo" src="gapVideo.mp4" preload="auto" playsinline muted></video>
    <video id="video2" src="video2.mp4" preload="auto" playsinline muted></video>
  </div>

  <audio id="myAudio" hidden preload="auto"></audio>
  <br>
  <button id="playButton">Play Synced Stimuli</button>

  <script>
    document.getElementById("playButton").addEventListener("click", async () => {
      const audio = document.getElementById("myAudio");
      const still1 = document.getElementById("stillframe1");
      const still2 = document.getElementById("stillframe2");
      const gapStill = document.getElementById("gapStillframe");
      const v1 = document.getElementById("video1");
      const vGap = document.getElementById("gapVideo");
      const v2 = document.getElementById("video2");

      const visuals = [
        { el: still1 },
        { el: v1 },
        { el: gapStill },
        { el: vGap },
        { el: v2 },
        { el: still2 }
      ];

      function hideAll() {
        visuals.forEach(v => {
          v.el.style.display = "none";
          if (v.el.tagName === "VIDEO") {
            v.el.pause();
            v.el.currentTime = 0;
          }
        });
      }

      hideAll();

      try {
        // Load audio and timing info from CSV
        const response = await fetch("audio_files.csv");
        if (!response.ok) throw new Error("CSV not found.");
        const csvText = await response.text();
        const rows = csvText.trim().split("\n").slice(1).map(line => line.split(",").map(cell => cell.trim()));
        if (rows.length === 0) throw new Error("CSV contains no data.");

        const [audioFile, originalDur, gapDur, testDur] = rows[Math.floor(Math.random() * rows.length)];
        const original = parseFloat(originalDur);
        const gap = parseFloat(gapDur);
        const test = parseFloat(testDur);

        if (isNaN(original) || isNaN(gap) || isNaN(test)) throw new Error("Invalid timing values in CSV.");

        // Wait for video metadata to load
        await Promise.all([
          new Promise(res => v1.onloadedmetadata = res),
          new Promise(res => vGap.onloadedmetadata = res),
          new Promise(res => v2.onloadedmetadata = res)
        ]);

        const v1Dur = v1.duration;
        const vGapDur = vGap.duration;
        const v2Dur = v2.duration;
        const still1Dur = original - v1Dur;

        if (still1Dur < 0) throw new Error("original duration must be greater than video1 duration");

        // Set timings
        let t = 0;
        visuals[0].start = t;
        visuals[0].end = t += still1Dur;

        visuals[1].start = t;
        visuals[1].end = t += v1Dur;

        visuals[2].start = t;
        visuals[2].end = t += gap;

        visuals[3].start = t;
        visuals[3].end = t += vGapDur;

        visuals[4].start = t;
        visuals[4].end = t += v2Dur;

        visuals[5].start = t;
        visuals[5].end = t += test;

        const totalTime = visuals[5].end;

        // Load and play audio
        audio.src = audioFile;
        await new Promise((resolve, reject) => {
          audio.oncanplaythrough = resolve;
          audio.onerror = () => reject("Audio failed to load.");
        });

        // Sync display to audio time
        let current = null;
        function syncVisuals() {
          const now = audio.currentTime;
          for (const v of visuals) {
            if (now >= v.start && now < v.end) {
              if (current !== v.el) {
                hideAll();
                v.el.style.display = "block";
                if (v.el.tagName === "VIDEO") v.el.play();
                current = v.el;
              }
              break;
            }
          }
          if (now < totalTime) {
            requestAnimationFrame(syncVisuals);
          } else {
            hideAll();
            console.log("Playback finished.");
          }
        }

        await audio.play();
        syncVisuals();

      } catch (err) {
        console.error("Error:", err);
        alert("Error syncing media. Check console for details.");
      }
    });
  </script>

</body>
</html>
